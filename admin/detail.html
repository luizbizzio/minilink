<script>
const API = 'https://url-shortener.luizbizzio.workers.dev';
const slug = new URLSearchParams(location.search).get('slug');
const TOKEN = localStorage.getItem('admin_token') || '';

(async () => {
  if (!slug) { document.body.textContent = 'No slug'; return; }
  if (!TOKEN) { location.href = '../index.html'; return; }   // volta para login

  const res = await fetch(`${API}/api/detail/${slug}`, {
    headers: { 'X-Admin-Token': TOKEN }
  });
  if (!res.ok) { alert('Forbidden (token inválido?)'); return; }

  const data = await res.json();
  document.getElementById('title').textContent = `Stats – ${slug}`;

  /* --- gráfico --- */
  const labels = Object.keys(data.byDay).sort();
  const values = labels.map(d => data.byDay[d]);
  new Chart(document.getElementById('chart'), {
    type: 'line',
    data: {
      labels: labels.map(d => `${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6)}`),
      datasets: [{ data: values, tension:0.3, fill:false }]
    },
    options: { plugins:{legend:{display:false}}, responsive:true }
  });

  /* --- mapa --- */
  const map = L.map('map', { worldCopyJump:true }).setView([20, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    { attribution:'© OSM' }).addTo(map);

  if (data.points && data.points.length) {
    const heat = data.points.map(([lat, lon]) => [lat, lon, 0.6]);
    L.heatLayer(heat, { radius: 25 }).addTo(map);
  }
})();
</script>
